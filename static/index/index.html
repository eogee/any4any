<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Any4Chat</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <link rel="stylesheet" href="/static/css/font-awesome.min.css">
    <link rel="stylesheet" href="/static/css/a4a.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Any4Chat</h1>
            <p>预览AI响应内容,人工审核编辑确保准确答复用户</p>
        </div>
        
        <div class="preview-container">
            <div class="preview-sidebar">
                <div class="sidebar-section">
                    <h3><i class="fas fa-list"></i> 待预览内容</h3>
                    <div class="preview-list" id="previewList">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>暂无待预览内容</p>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3><i class="fas fa-chart-bar"></i> 统计</h3>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="previewCount">0</div>
                            <div class="stat-label">待预览</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="approvedCount">0</div>
                            <div class="stat-label">已回复</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="preview-main">
                <div class="preview-detail" id="previewDetail">
                    <div class="empty-state" id="emptyState">
                        <i class="fas fa-search"></i>
                        <p>请选择一项内容预览</p>
                    </div>
                    <div class="content-editor-container" id="editorContainer" style="display: none;">
                        <textarea class="content-editor" id="contentEditor" placeholder="编辑内容..."></textarea>
                        <div class="content-preview" id="contentPreview"></div>
                        <div class="editor-actions">
                            <button class="layui-btn layui-btn-normal" id="saveAndSendBtn"><i class="fas fa-save"></i> 保存发送</button>
                            <button class="layui-btn layui-btn-primary" id="cancelBtn"><i class="fas fa-times"></i> 取消</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/layui/layui.js"></script>
    <script src="/static/js/marked.min.js"></script>
    <script>
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        let currentPreviewId = null;
        let previewPollingInterval = null;
        let previews = [];
        let layer = null;

        const previewList = document.getElementById('previewList');
        const previewDetail = document.getElementById('previewDetail');
        const previewCount = document.getElementById('previewCount');
        const approvedCount = document.getElementById('approvedCount');
        const emptyState = document.getElementById('emptyState');
        const editorContainer = document.getElementById('editorContainer');
        const contentEditor = document.getElementById('contentEditor');
        const contentPreview = document.getElementById('contentPreview');

        function removeThinkContent(text) {
            if (!text) return '';
            return text.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
        }

        function processThinkContent(text) {
            if (!text) return '';
            
            const thinkPattern = /<think>([\s\S]*?)<\/think>/g;
            let processedText = text;
            let thinkCount = 0;

            processedText = processedText.replace(thinkPattern, (match, content) => {
                const formattedContent = content.trim().split('\n').map(line => line.trim()).filter(line => line.length > 0).join('\n');
                const uniqueId = `think-${Date.now()}-${thinkCount}`;
                thinkCount++;
                
                return `<div class="think-container">
                    <button class="think-toggle" onclick="toggleThink('${uniqueId}')">
                        <i class="fas fa-lightbulb"></i> 思考过程
                    </button>
                    <div id="${uniqueId}" class="think-content" style="display: none;">${formattedContent}</div>
                </div>`;
            });

            return processedText;
        }

        window.toggleThink = function(thinkId) {
            const content = document.getElementById(thinkId);
            if (!content) return;
            
            const button = content.previousElementSibling;
            const isHidden = content.style.display === 'none';
            
            content.style.display = isHidden ? 'block' : 'none';
            button.innerHTML = isHidden ? 
                '<i class="fas fa-lightbulb"></i> 收起思考' :
                '<i class="fas fa-lightbulb"></i> 思考过程';
        }

        function renderMarkdown(content) {
            if (!content) return '';
            
            try {
                content = processThinkContent(content);
                
                const thinkBlocks = [];
                content = content.replace(/<div class="think-container">[\s\S]*?<\/div><\/div>/g, (match) => {
                    const id = `THINK_BLOCK_${thinkBlocks.length}`;
                    thinkBlocks.push({id: id, content: match});
                    return id;
                });

                content = marked.parse(content);

                thinkBlocks.forEach(block => {
                    content = content.replace(new RegExp(block.id, 'g'), block.content);
                });

                return content;
            } catch (e) {
                console.error('渲染错误:', e);
                return content;
            }
        }

        async function pollPreviewData() {
            try {
                const response = await fetch('/api/pending-previews');
                if (response.ok) {
                    const data = await response.json();
                    previews = Array.isArray(data) ? data : (data.previews || []);
                    
                    if (previews.length > 0) {
                        renderPreviewList();
                        updateStats();
                        
                        if (currentPreviewId && !previews.find(p => p.preview_id === currentPreviewId)) {
                            currentPreviewId = null;
                            renderPreviewDetail(null);
                        }
                    } else {
                        renderPreviewList();
                        updateStats();
                    }
                }
            } catch (error) {
                console.error('数据获取失败:', error);
            }
        }
        
        function startPreviewPolling() {
            if (previewPollingInterval) clearInterval(previewPollingInterval);
            previewPollingInterval = setInterval(pollPreviewData, 3000);
            pollPreviewData();
        }
        
        function stopPreviewPolling() {
            if (previewPollingInterval) {
                clearInterval(previewPollingInterval);
                previewPollingInterval = null;
            }
        }

        function renderPreviewList() {
            if (!previewList) return;
            
            if (previews.length === 0) {
                previewList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>暂无待预览内容</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            previews.forEach(preview => {
                const isActive = preview.preview_id === currentPreviewId;
                const previewTime = new Date(preview.timestamp || Date.now()).toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let lastUserMessage = '无内容';
                const messages = preview.request_data?.messages;
                if (messages && Array.isArray(messages)) {
                    for (let i = messages.length - 1; i >= 0; i--) {
                        if (messages[i].role === 'user') {
                            lastUserMessage = messages[i].content || '无内容';
                            break;
                        }
                    }
                }
                
                let previewContent = preview.generated_content || '等待响应...';
                previewContent = removeThinkContent(previewContent);
                if (previewContent.length > 100) {
                    previewContent = previewContent.substring(0, 100) + '...';
                }
                
                html += `
                    <div class="preview-item ${isActive ? 'active' : ''}" data-id="${preview.preview_id}">
                        <div class="preview-item-header">
                            <div class="preview-item-title">${lastUserMessage}</div>
                            <div class="preview-item-time">${previewTime}</div>
                        </div>
                        <div class="preview-item-content">${previewContent}</div>
                    </div>
                `;
            });
            
            previewList.innerHTML = html;
            
            document.querySelectorAll('.preview-item').forEach(item => {
                item.addEventListener('click', function() {
                    const previewId = this.getAttribute('data-id');
                    selectPreviewItem(previewId);
                });
            });
        }

        function selectPreviewItem(previewId) {
            currentPreviewId = previewId;
            renderPreviewList();
            const selectedPreview = previews.find(p => p.preview_id === previewId);
            renderPreviewDetail(selectedPreview);
        }

        function renderPreviewDetail(preview) {
            if (!previewDetail) return;
            
            if (!preview) {
                if (emptyState) emptyState.style.display = 'flex';
                if (editorContainer) editorContainer.style.display = 'none';
                const previewContent = document.getElementById('previewContent');
                if (previewContent) previewContent.style.display = 'none';
                return;
            }
            
            if (emptyState) emptyState.style.display = 'none';
            if (editorContainer) editorContainer.style.display = 'none';
            
            let previewContent = document.getElementById('previewContent');
            if (!previewContent) {
                previewContent = document.createElement('div');
                previewContent.id = 'previewContent';
                previewDetail.appendChild(previewContent);
            }
            
            previewContent.style.display = 'block';
            
            const requestData = preview.request_data || {};
            const responseContent = preview.generated_content || "等待响应...";
            
            let lastUserQuestion = '无问题';
            const messages = requestData.messages;
            if (messages && Array.isArray(messages)) {
                for (let i = messages.length - 1; i >= 0; i--) {
                    if (messages[i].role === 'user') {
                        lastUserQuestion = messages[i].content || '无问题';
                        break;
                    }
                }
            }
            
            let lastAssistantMessage = null;
            if (messages && Array.isArray(messages)) {
                for (let i = messages.length - 1; i >= 0; i--) {
                    if (messages[i].role === 'assistant') {
                        lastAssistantMessage = messages[i];
                        break;
                    }
                }
            }
            
            previewContent.innerHTML = `
                <div class="preview-section">
                    <h3><i class="fas fa-question-circle"></i> 当前问题</h3>
                    <div class="preview-request">${lastUserQuestion}</div>
                </div>
                
                <div class="preview-section">
                    <h3><i class="fas fa-paper-plane"></i> 会话历史</h3>
                    <div class="request-table-container">
                        <table class="request-table">
                            <thead>
                                <tr>
                                    <th>用户消息</th>
                                    <th>助手回复</th>
                                </tr>
                            </thead>
                            <tbody id="requestTableBody">
                                <tr><td colspan="2" class="loading-state">加载中...</td></tr>
                            </tbody>
                        </table>
                        <button class="table-toggle-btn" id="toggleRequestTable">
                            <i class="fas fa-chevron-down"></i> 显示更多
                        </button>
                    </div>
                </div>                
                <div class="preview-section">
                    <h3><i class="fas fa-robot"></i> AI响应</h3>
                    <div class="preview-response markdown-body">${renderMarkdown(responseContent)}</div>
                </div>
                
                <div class="preview-actions">
                    ${lastAssistantMessage && lastAssistantMessage.is_timeout === 1 ? 
                        `<button class="layui-btn layui-btn-warm" id="confirmTimeoutBtn">
                            <i class="fas fa-warning"></i> 确认超时回复
                        </button>` : 
                        `<button class="layui-btn layui-btn-normal" id="editBtn">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        <button class="layui-btn layui-btn-primary" id="confirmBtnDetail">
                            <i class="fas fa-check"></i> 确认发送
                        </button>`
                    }
                </div>`;
            
            const editBtn = document.getElementById('editBtn');
            const confirmBtnDetail = document.getElementById('confirmBtnDetail');
            const confirmTimeoutBtn = document.getElementById('confirmTimeoutBtn');
            
            if (editBtn) editBtn.onclick = () => startEditMode(preview);
            if (confirmBtnDetail) confirmBtnDetail.onclick = () => confirmPreview(preview.preview_id);
            if (confirmTimeoutBtn) confirmTimeoutBtn.onclick = handleTimeoutConfirm;
            
            const conversationId = requestData.conversation_id;
            if (conversationId) {
                loadConversationHistory(conversationId);
            } else {
                const tableBody = document.getElementById('requestTableBody');
                tableBody.innerHTML = '<tr><td colspan="2" class="empty-state">无对话历史</td></tr>';
            }
        }
        
        async function loadConversationHistory(conversationId) {
            try {
                const response = await fetch(`/api/conversation/${conversationId}/messages`);
                const data = await response.json();
                
                if (data.success) {
                    const reversedMessages = [...data.messages].reverse();
                    renderConversationMessages(reversedMessages);
                    updateButtonsByTimeoutStatus(data.messages);
                } else {
                    const tableBody = document.getElementById('requestTableBody');
                    tableBody.innerHTML = '<tr><td colspan="2" class="error-state">加载失败</td></tr>';
                }
            } catch (error) {
                const tableBody = document.getElementById('requestTableBody');
                tableBody.innerHTML = '<tr><td colspan="2" class="error-state">网络错误</td></tr>';
            }
        }
        
        function updateButtonsByTimeoutStatus(messages) {
            if (!messages || !Array.isArray(messages)) return;
            
            let lastAssistantMessage = null;
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].sender_type === 'assistant') {
                    lastAssistantMessage = messages[i];
                    break;
                }
            }
            
            if (lastAssistantMessage && lastAssistantMessage.is_timeout === 1) {
                const previewActions = document.querySelector('.preview-actions');
                if (previewActions) {
                    previewActions.innerHTML = `
                        <button class="layui-btn layui-btn-warm" id="confirmTimeoutBtn">
                            <i class="fas fa-warning"></i> 确认超时回复
                        </button>
                    `;
                    
                    const confirmTimeoutBtn = document.getElementById('confirmTimeoutBtn');
                    if (confirmTimeoutBtn) confirmTimeoutBtn.onclick = handleTimeoutConfirm;
                }
            }
        }
        
        function renderConversationMessages(messages) {
            const tableBody = document.getElementById('requestTableBody');
            
            if (!messages || messages.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="2" class="empty-state">无对话消息</td></tr>';
                return;
            }
            
            const pairs = [];
            let currentPair = null;
            
            for (let j = 0; j < messages.length; j++) {
                const msg = messages[j];
                
                if (msg.sender_type === 'user') {
                    if (currentPair) pairs.push(currentPair);
                    currentPair = { user: msg, assistant: null };
                } else if (msg.sender_type === 'assistant' && currentPair) {
                    currentPair.assistant = msg;
                    pairs.push(currentPair);
                    currentPair = null;
                }
            }
            
            if (currentPair) pairs.push(currentPair);
            
            tableBody.innerHTML = '';
            
            const assistantMessages = pairs.map(pair => pair.assistant ? pair.assistant.content : '');
            
            for (let k = 0; k < pairs.length; k++) {
                const pair = pairs[k];
                const row = document.createElement('tr');
                row.className = 'message-pair';
                row.setAttribute('data-row-index', k.toString());
                
                const userCell = document.createElement('td');
                userCell.className = 'user-message';
                if (pair.user && pair.user.content) userCell.innerHTML = escapeHtml(pair.user.content);
                
                const assistantCell = document.createElement('td');
                assistantCell.className = 'assistant-message';
                
                if (k === 0) {
                    assistantCell.innerHTML = '待确认回复...';
                } else {
                    const previousAssistantContent = assistantMessages[k - 1];
                    if (previousAssistantContent) assistantCell.innerHTML = escapeHtml(previousAssistantContent);
                }
                
                row.appendChild(userCell);
                row.appendChild(assistantCell);
                tableBody.appendChild(row);
            }
            
            setupTableToggle();
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
                .replace(/\n/g, '<br>');
        }
        
        function setupTableToggle() {
            const toggleBtn = document.getElementById('toggleRequestTable');
            const tableBody = document.getElementById('requestTableBody');
            
            if (toggleBtn && tableBody) {
                let isExpanded = false;
                const rows = tableBody.querySelectorAll('tr.message-pair');
                
                if (rows.length > 3) {
                    for (let i = 3; i < rows.length; i++) rows[i].style.display = 'none';
                    toggleBtn.style.display = 'block';
                } else toggleBtn.style.display = 'none';
                
                toggleBtn.addEventListener('click', function() {
                    isExpanded = !isExpanded;
                    
                    if (isExpanded) {
                        for (let i = 1; i < rows.length; i++) rows[i].style.display = '';
                        toggleBtn.innerHTML = '<i class="fas fa-chevron-up"></i> 收起';
                    } else {
                        for (let i = 3; i < rows.length; i++) rows[i].style.display = 'none';
                        toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i> 显示更多';
                    }
                });
            }
        }

        function startEditMode(preview) {            
            if (!emptyState || !editorContainer || !contentEditor || !contentPreview) {
                if (layer) layer.msg('编辑器初始化失败', {icon: 2, time: 2000});
                return;
            }
            
            try {
                currentPreviewId = preview.preview_id;
                
                if (emptyState) emptyState.style.display = 'none';
                const previewContent = document.getElementById('previewContent');
                if (previewContent) previewContent.style.display = 'none';
                editorContainer.style.display = 'flex';
                
                contentEditor.value = preview.generated_content || '';
                contentPreview.innerHTML = renderMarkdown(contentEditor.value);
                
                setTimeout(() => contentEditor.focus(), 100);
            } catch (error) {
                if (layer) layer.msg('编辑模式启动失败', {icon: 2, time: 1500});
            }
        }

        async function confirmPreview(previewId) {
            try {
                const preview = previews.find(p => p.preview_id === previewId);
                if (!preview) throw new Error('未找到预览数据');
                
                const requestBody = {
                    sender_id: preview.sender_id || preview.user_id || '',
                    sender_name: preview.sender_name || preview.username || '',
                    original_content: preview.original_content || '',
                    request_id: preview.request_id || preview.preview_id
                };
                
                const response = await fetch(`/v1/chat/confirm/${previewId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody)
                });
                
                if (response.ok) {
                    if (layer) layer.msg('内容已发送', {icon: 1, time: 1500});
                    pollPreviewData();
                } else throw new Error('服务器错误');
            } catch (error) {
                if (layer) layer.msg('发送失败', {icon: 2, time: 1500});
            }
        }

        function handleTimeoutConfirm() {
            if (layer) layer.msg('已确认超时回复', {icon: 1, time: 1500});
            
            if (currentPreviewId) {
                const index = previews.findIndex(p => p.preview_id === currentPreviewId);
                if (index !== -1) previews.splice(index, 1);
                
                currentPreviewId = null;
                renderPreviewList();
                updateStats();
                
                if (emptyState) emptyState.style.display = 'flex';
                const previewContent = document.getElementById('previewContent');
                if (previewContent) previewContent.style.display = 'none';
                if (editorContainer) editorContainer.style.display = 'none';
            }
            
            setTimeout(pollPreviewData, 200);
        }

        function updateStats() {
            if (previewCount) previewCount.textContent = previews.length;
            if (approvedCount) approvedCount.textContent = Math.floor(previews.length * 0.7);
        }

        function initEditor() {
            const saveAndSendBtn = document.getElementById('saveAndSendBtn');
            const cancelBtn = document.getElementById('cancelBtn');

            if (!contentEditor || !contentPreview || !saveAndSendBtn || !cancelBtn) {
                setTimeout(initEditor, 100);
                return;
            }

            contentEditor.addEventListener('input', function() {
                contentPreview.innerHTML = renderMarkdown(this.value);
            });

            saveAndSendBtn.addEventListener('click', async function() {
                if (!currentPreviewId) return;
                
                try {
                    const preview = previews.find(p => p.preview_id === currentPreviewId);
                    if (!preview) throw new Error('未找到预览数据');
                    
                    const additionalFields = {
                        sender_id: preview.sender_id || preview.user_id || '',
                        sender_name: preview.sender_name || preview.username || '',
                        original_content: preview.original_content || '',
                        request_id: preview.request_id || preview.preview_id
                    };
                    
                    const saveResponse = await fetch(`/api/previews/${currentPreviewId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({content: contentEditor.value, ...additionalFields})
                    });

                    if (!saveResponse.ok) throw new Error('保存失败');

                    const confirmResponse = await fetch(`/v1/chat/confirm/${currentPreviewId}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(additionalFields)
                    });

                    if (confirmResponse.ok) {
                        if (layer) layer.msg('内容已发送', {icon: 1, time: 1500});
                        if (editorContainer) editorContainer.style.display = 'none';
                        if (emptyState) emptyState.style.display = 'flex';
                        pollPreviewData();
                    } else throw new Error('发送失败');
                } catch (error) {
                    if (layer) layer.msg('发送失败', {icon: 2, time: 1500});
                }
            });

            cancelBtn.addEventListener('click', function() {
                if (editorContainer) editorContainer.style.display = 'none';
                
                if (currentPreviewId) {
                    const selectedPreview = previews.find(p => p.preview_id === currentPreviewId);
                    if (selectedPreview) renderPreviewDetail(selectedPreview);
                    else {
                        if (emptyState) emptyState.style.display = 'flex';
                        const previewContent = document.getElementById('previewContent');
                        if (previewContent) previewContent.style.display = 'none';
                    }
                } else {
                    if (emptyState) emptyState.style.display = 'flex';
                    const previewContent = document.getElementById('previewContent');
                    if (previewContent) previewContent.style.display = 'none';
                }
            });
        }

        layui.use(['layer', 'form'], function(){
            layer = layui.layer;
            var form = layui.form;
            
            startPreviewPolling();
            setTimeout(initEditor, 100);

            window.confirmPreview = confirmPreview;

            window.addEventListener('beforeunload', function() {
                stopPreviewPolling();
            });
            
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) stopPreviewPolling();
                else startPreviewPolling();
            });
        });
    </script>
</body>
</html>