# Any4Any 功能测试文档

## 1. 测试概述

### 1.1 测试目标
验证 Any4Any 系统的各项核心功能是否正常工作，包括会话管理、预览模式、用户认证、API接口等功能模块，确保系统稳定可靠。

### 1.2 测试环境
- 操作系统：Windows/Linux
- Python 版本：3.8+
- 依赖库：见 requirements.txt
- 数据库：MySQL 5.7+

### 1.3 测试范围
- 会话管理功能
- 预览模式功能
- 用户认证系统
- OpenAI API 兼容接口
- MCP服务功能
- 前端页面功能

## 2. 功能测试用例

### 2.1 会话管理功能测试

#### 2.1.1 创建新会话
**测试目的**：验证系统能否正确创建新会话
**测试步骤**：
1. 发送 `/a` 指令到聊天接口
2. 验证返回结果是否包含新会话创建成功信息
3. 检查数据库 conversations 表是否有新记录

**预期结果**：
- 返回消息："新会话已开启。"
- conversations 表中新增一条记录，message_count 为 0

#### 2.1.2 发送消息到会话
**测试目的**：验证用户能否向会话发送消息并获得响应
**测试步骤**：
1. 向系统发送一条普通文本消息
2. 验证是否收到助手回复
3. 检查数据库 messages 表是否包含用户消息和助手回复

**预期结果**：
- 成功收到助手回复
- messages 表中新增两条记录（用户消息和助手回复）
- conversations 表中对应会话的 message_count 增加

#### 2.1.3 上下文对话
**测试目的**：验证系统是否支持上下文连续对话
**测试步骤**：
1. 发送第一条消息，如"你好"
2. 发送第二条消息，如"我刚才说什么了？"
3. 验证助手回复是否能够理解上下文

**预期结果**：
- 助手能够正确回复关于之前对话的问题
- 消息顺序正确，sequence_number 递增

#### 2.1.4 多平台会话隔离
**测试目的**：验证不同平台的会话是否相互隔离
**测试步骤**：
1. 使用 platform="web" 发送消息
2. 使用 platform="app" 发送另一条消息
3. 验证两个平台的会话是独立的

**预期结果**：
- 两个平台生成不同的 conversation_id
- 消息分别保存在各自的会话中

### 2.2 预览模式功能测试

#### 2.2.1 启用预览模式
**测试目的**：验证预览模式是否正确启用
**测试步骤**：
1. 确保配置中 PREVIEW_MODE = True
2. 发送消息到系统
3. 验证是否返回预览ID

**预期结果**：
- 返回数据中包含 preview_id
- 预览状态为未确认

#### 2.2.2 预览内容更新
**测试目的**：验证能否更新预览内容
**测试步骤**：
1. 创建预览请求
2. 调用更新预览接口，修改内容
3. 检查是否成功更新

**预期结果**：
- 预览内容被成功更新
- previews 表中保存了编辑前后的内容

#### 2.2.3 确认预览内容
**测试目的**：验证确认预览后能否返回最终内容
**测试步骤**：
1. 创建预览请求
2. 更新预览内容
3. 调用确认预览接口
4. 验证返回结果

**预期结果**：
- 返回最终确认的内容
- 触发确认回调函数
- 预览状态变为已确认

#### 2.2.4 预览超时处理
**测试目的**：验证预览超时后的行为
**测试步骤**：
1. 创建预览请求
2. 等待超过 PREVIEW_TIMEOUT 时间
3. 检查系统行为

**预期结果**：
- 预览超时后自动处理
- 不阻塞系统其他功能

### 2.3 用户认证系统测试

#### 2.3.1 用户登录
**测试目的**：验证用户能否成功登录系统
**测试步骤**：
1. 使用正确的用户名和密码（admin/888888）登录
2. 验证登录是否成功
3. 检查会话是否创建

**预期结果**：
- 登录成功，返回成功状态
- 系统创建会话并设置会话cookie

#### 2.3.2 错误密码登录
**测试目的**：验证错误密码登录的处理
**测试步骤**：
1. 使用正确用户名但错误密码登录
2. 验证登录是否失败

**预期结果**：
- 登录失败，返回错误信息
- 不创建会话

#### 2.3.3 未登录访问保护页面
**测试目的**：验证未登录用户是否被重定向到登录页面
**测试步骤**：
1. 清除所有cookie
2. 访问首页或其他需要登录的页面
3. 验证是否被重定向到登录页面

**预期结果**：
- 被重定向到登录页面
- URL包含原始请求页面的引用

### 2.4 OpenAI API 兼容接口测试

#### 2.4.1 聊天完成接口
**测试目的**：验证/v1/chat/completions接口是否正常工作
**测试步骤**：
1. 发送POST请求到/v1/chat/completions
2. 请求体包含messages数组
3. 验证返回格式是否符合OpenAI API规范

**预期结果**：
- 返回正确格式的JSON响应
- 包含id、object、created、model、choices和usage字段
- choices数组包含生成的消息

#### 2.4.2 模型列表接口
**测试目的**：验证/v1/models接口是否正常工作
**测试步骤**：
1. 发送GET请求到/v1/models
2. 验证返回格式和内容

**预期结果**：
- 返回格式符合OpenAI API规范
- 包含可用模型列表

#### 2.4.3 流式响应测试
**测试目的**：验证流式响应模式是否正常工作
**测试步骤**：
1. 发送请求，设置stream=true
2. 验证是否返回SSE格式的流式响应

**预期结果**：
- 成功接收流式数据
- 数据格式符合OpenAI API的流式响应规范

### 2.5 MCP服务功能测试

#### 2.5.1 启动MCP服务
**测试目的**：验证MCP服务能否正常启动
**测试步骤**：
1. 调用run_mcp_server()函数
2. 验证服务是否在配置的端口上启动

**预期结果**：
- MCP服务成功启动
- 监听配置的端口（默认为9999）
- 日志显示服务启动成功

#### 2.5.2 MCP工具调用
**测试目的**：验证能否通过MCP协议调用工具
**测试步骤**：
1. 确保MCP服务已启动
2. 使用MCP客户端调用已注册的工具（如add、sub、mul、div）
3. 验证调用结果

**预期结果**：
- 工具调用成功
- 返回正确的计算结果

### 2.6 前端页面功能测试

#### 2.6.1 登录页面
**测试目的**：验证登录页面功能是否正常
**测试步骤**：
1. 访问登录页面
2. 输入用户名密码登录
3. 验证页面跳转

**预期结果**：
- 登录页面正确显示
- 登录成功后跳转到首页
- 登录失败显示错误信息

#### 2.6.2 首页预览功能
**测试目的**：验证首页的预览功能
**测试步骤**：
1. 确保已登录
2. 访问首页
3. 查看预览区域
4. 尝试编辑和确认预览内容

**预期结果**：
- 预览区域正确显示等待确认的内容
- 可以编辑预览内容
- 确认后内容被正确处理

## 3. 数据库操作测试

### 3.1 会话数据存取
**测试目的**：验证会话数据是否正确存储和读取
**测试步骤**：
1. 创建新会话并发送消息
2. 查询数据库验证数据完整性
3. 通过API获取会话数据
4. 验证返回数据与数据库一致

**预期结果**：
- 数据库中会话和消息数据完整
- API返回的会话数据与数据库一致

### 3.2 预览数据存储
**测试目的**：验证预览数据是否正确存储
**测试步骤**：
1. 创建预览并更新内容
2. 查询previews表
3. 验证数据字段完整性

**预期结果**：
- previews表中包含完整的预览数据
- 编辑前后的内容都被正确保存
- 关联的conversation_id和message_id正确

## 4. 性能测试

### 4.1 响应时间测试
**测试目的**：验证系统响应时间是否在可接受范围内
**测试步骤**：
1. 发送消息到系统
2. 记录从发送到接收响应的时间
3. 进行多次测试取平均值

**预期结果**：
- 简单消息的响应时间不超过5秒
- 预览模式下的响应时间不超过10秒

### 4.2 并发测试
**测试目的**：验证系统在并发请求下的稳定性
**测试步骤**：
1. 模拟多个并发用户发送请求
2. 验证系统是否正常处理所有请求
3. 检查是否有错误或数据丢失

**预期结果**：
- 系统能够处理至少10个并发请求
- 没有数据丢失或错误
- 响应时间增加但在可接受范围内

## 5. 安全测试

### 5.1 认证安全
**测试目的**：验证系统认证机制的安全性
**测试步骤**：
1. 尝试使用SQL注入方式登录
2. 尝试未授权访问受保护的API
3. 测试会话超时功能

**预期结果**：
- SQL注入尝试失败
- 未授权访问被拒绝
- 会话超时时自动退出登录

### 5.2 数据验证
**测试目的**：验证系统对输入数据的验证
**测试步骤**：
1. 发送格式错误的请求
2. 发送包含特殊字符的消息
3. 测试边界条件（超长消息等）

**预期结果**：
- 格式错误的请求被拒绝
- 特殊字符被正确处理
- 超长消息有适当的错误提示

## 6. 测试结果记录

### 6.1 测试结果表格

| 测试模块 | 测试用例 | 测试结果 | 备注 |
|---------|---------|---------|------|
| 会话管理 | 创建新会话 | | |
| 会话管理 | 发送消息到会话 | | |
| 会话管理 | 上下文对话 | | |
| 会话管理 | 多平台会话隔离 | | |
| 预览模式 | 启用预览模式 | | |
| 预览模式 | 预览内容更新 | | |
| 预览模式 | 确认预览内容 | | |
| 预览模式 | 预览超时处理 | | |
| 用户认证 | 用户登录 | | |
| 用户认证 | 错误密码登录 | | |
| 用户认证 | 未登录访问保护页面 | | |
| OpenAI API | 聊天完成接口 | | |
| OpenAI API | 模型列表接口 | | |
| OpenAI API | 流式响应测试 | | |
| MCP服务 | 启动MCP服务 | | |
| MCP服务 | MCP工具调用 | | |
| 前端页面 | 登录页面 | | |
| 前端页面 | 首页预览功能 | | |
| 数据库操作 | 会话数据存取 | | |
| 数据库操作 | 预览数据存储 | | |

### 6.2 问题跟踪

| 问题ID | 问题描述 | 严重程度 | 状态 | 修复方案 |
|-------|---------|---------|------|--------|
| | | | | |
| | | | | |

## 7. 测试结论

### 7.1 总体评估
基于测试结果对系统功能的总体评估。

### 7.2 建议和改进
测试过程中发现的问题和改进建议。

### 7.3 测试覆盖度
测试用例对系统功能的覆盖程度评估。

---

测试文档版本：v1.0
测试日期：
测试人员：